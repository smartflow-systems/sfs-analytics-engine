import express from "express";
import { readFileSync, writeFileSync, existsSync, mkdirSync } from "fs";
import { join } from "path";
import net from "net";

const app = express();

// -------------------------------
// Middleware
// -------------------------------
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// -------------------------------
// Ensure directories exist
// -------------------------------
const dataDir = "./data";
const publicDir = "./public";

if (!existsSync(dataDir)) mkdirSync(dataDir, { recursive: true });
if (!existsSync(publicDir)) mkdirSync(publicDir, { recursive: true });

// -------------------------------
// Initialize JSON files if missing
// -------------------------------
const leadsFile = join(dataDir, "leads.json");
if (!existsSync(leadsFile)) writeFileSync(leadsFile, JSON.stringify({ leads: [] }, null, 2));

const siteConfigFile = join(publicDir, "site.config.json");
if (!existsSync(siteConfigFile)) {
  writeFileSync(siteConfigFile, JSON.stringify({
    siteName: "SmartFlow",
    theme: "dark",
    version: "0.1.0"
  }, null, 2));
}

const pricingFile = join(publicDir, "pricing.json");
if (!existsSync(pricingFile)) writeFileSync(pricingFile, JSON.stringify({ plans: [] }, null, 2));

// -------------------------------
// Load site config
// -------------------------------
const config = JSON.parse(readFileSync(siteConfigFile, "utf-8"));

// -------------------------------
// Helper functions for leads
// -------------------------------
function readLeads() {
  try {
    const data = readFileSync(leadsFile, "utf-8");
    return JSON.parse(data);
  } catch (err) {
    console.error("Error reading leads:", err);
    return { leads: [] };
  }
}

function writeLeads(data) {
  try {
    writeFileSync(leadsFile, JSON.stringify(data, null, 2));
    return true;
  } catch (err) {
    console.error("Error writing leads:", err);
    return false;
  }
}

// -------------------------------
// Serve static files
// -------------------------------
app.use(express.static(publicDir));

// -------------------------------
// Health checks
// -------------------------------
app.get("/health", (_req, res) => res.json({
  ok: true,
  siteName: config.siteName,
  version: config.version
}));

app.get("/api/health", (_req, res) => res.json({
  ok: true,
  siteName: config.siteName,
  version: config.version
}));

// -------------------------------
// Leads API
// -------------------------------
app.post("/api/leads", (req, res) => {
  try {
    const { firstName, lastName, email, company, phone, source } = req.body;
    if (!firstName || !lastName || !email) {
      return res.status(400).json({ success: false, message: "First name, last name, and email are required" });
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) return res.status(400).json({ success: false, message: "Invalid email format" });

    const data = readLeads();
    const existingLead = data.leads.find(lead => lead.email === email);
    if (existingLead) return res.status(200).json({ success: true, message: "Lead already exists", leadId: existingLead.id });

    const newLead = {
      id: `lead_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      firstName, lastName, email,
      company: company || "", phone: phone || "", source: source || "direct",
      status: "new",
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    data.leads.push(newLead);
    if (!writeLeads(data)) throw new Error("Failed to save lead");
    console.log(`âœ“ New lead captured: ${email}`);

    res.status(201).json({ success: true, message: "Lead captured successfully", leadId: newLead.id });
  } catch (err) {
    console.error("Lead submission error:", err);
    res.status(500).json({ success: false, message: "Internal server error" });
  }
});

app.get("/api/leads", (_req, res) => {
  try {
    const data = readLeads();
    res.json({ success: true, count: data.leads.length, leads: data.leads });
  } catch (err) {
    console.error("Error fetching leads:", err);
    res.status(500).json({ success: false, message: "Failed to fetch leads" });
  }
});

// -------------------------------
// Stripe checkout placeholder
// -------------------------------
app.post("/api/stripe/checkout", (req, res) => {
  try {
    const { planId } = req.body;
    const pricingData = JSON.parse(readFileSync(pricingFile, "utf-8"));
    const plan = pricingData.plans.find(p => p.id === planId);

    if (!plan) return res.status(404).json({ success: false, message: "Plan not found" });

    console.log(`Checkout requested for plan: ${planId}`);
    res.json({
      success: true,
      message: "Stripe integration pending",
      planId,
      plan: plan.name,
      price: plan.price,
      url: `/contact.html?plan=${planId}`
    });
  } catch (err) {
    console.error("Checkout error:", err);
    res.status(500).json({ success: false, message: "Failed to create checkout session" });
  }
});

// -------------------------------
// Port auto-switching
// -------------------------------
const DEFAULT_PORT = parseInt(process.env.PORT || "5000", 10);

async function findFreePort(port) {
  return new Promise((resolve) => {
    const tester = net.createServer()
      .once("error", () => resolve(findFreePort(port + 1)))
      .once("listening", () => tester.close(() => resolve(port)))
      .listen(port);
  });
}

(async () => {
  const port = await findFreePort(DEFAULT_PORT);
  app.listen(port, () => console.log(`serving on ${port}`));
})();

export default app;
